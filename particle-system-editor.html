<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Particle Visualization System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="controls">
        <h3>3D Particle Visualization System</h3>
        
        <button onclick="addParticles(1)">Add 1 Particle</button>
        <button onclick="addParticles(10)">Add 10 Particles</button>
        <button onclick="addParticles(100)">Add 100 Particles</button>
        <button onclick="clearParticles()">Clear All</button>
        
        <!-- Particle Settings -->
        <div class="control-section">
            <div class="section-header" onclick="toggleSection(event)">
                <h4>Particle Settings</h4>
                <div class="section-toggle">▶</div>
            </div>
            <div class="section-content">
                <div style="margin: 10px 0;">
                    <label>Size: <span id="sizeValue">2</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="size" min="0.5" max="10" step="0.5" value="2" style="flex: 1;"
                               oninput="document.getElementById('sizeValue').textContent = this.value; document.getElementById('sizeInput').value = this.value">
                        <input type="number" id="sizeInput" min="0.5" max="10" step="0.5" value="2" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(0.5, Math.min(10, this.value)); document.getElementById('size').value = this.value; document.getElementById('sizeValue').textContent = this.value">
                    </div>
                </div>
                
                <div style="margin: 10px 0;">
                    <label>Speed: <span id="speedValue">1</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="speed" min="0" max="5" step="0.1" value="1" style="flex: 1;"
                               oninput="document.getElementById('speedValue').textContent = this.value; document.getElementById('speedInput').value = this.value">
                        <input type="number" id="speedInput" min="0" max="5" step="0.1" value="1" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(0, Math.min(5, this.value)); document.getElementById('speed').value = this.value; document.getElementById('speedValue').textContent = this.value">
                    </div>
                </div>
                
                <div style="margin: 10px 0;">
                    <label>Layer: <span id="layerValue">1</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="layer" min="1" max="20" step="1" value="1" style="flex: 1;"
                               oninput="document.getElementById('layerValue').textContent = this.value; document.getElementById('layerInput').value = this.value">
                        <input type="number" id="layerInput" min="1" max="20" step="1" value="1" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(1, Math.min(20, this.value)); document.getElementById('layer').value = this.value; document.getElementById('layerValue').textContent = this.value">
                    </div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Size Reduction/Layer: <span id="reductionValue">0.1</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="reduction" min="0" max="2" step="0.1" value="0.1" style="flex: 1;"
                               oninput="document.getElementById('reductionValue').textContent = this.value; document.getElementById('reductionInput').value = this.value">
                        <input type="number" id="reductionInput" min="0" max="2" step="0.1" value="0.1" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(0, Math.min(2, this.value)); document.getElementById('reduction').value = this.value; document.getElementById('reductionValue').textContent = this.value">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3D Rotation -->
        <div class="control-section">
            <div class="section-header" onclick="toggleSection(event)">
                <h4>3D Rotation</h4>
                <div class="section-toggle">▶</div>
            </div>
            <div class="section-content">
                <div style="margin: 8px 0;">
                    <label>
                        <input type="checkbox" id="animateRotation" checked onchange="toggleAnimation()">
                        Animate Rotation
                    </label>
                    <div style="font-size: 9px; color: #666;">When off: drag sliders to rotate manually</div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>
                        <input type="checkbox" id="hoverRotate" onchange="toggleHoverRotate()">
                        Hover Rotate
                    </label>
                    <div style="font-size: 9px; color: #666;">Mouse position controls rotation</div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Hover Max: <span id="hoverMaxValue">45</span>°</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="hoverMax" min="5" max="180" step="1" value="45" style="flex: 1;"
                               oninput="document.getElementById('hoverMaxValue').textContent = this.value; document.getElementById('hoverMaxInput').value = this.value; lastHoverMaxCache = parseFloat(this.value)">
                        <input type="number" id="hoverMaxInput" min="5" max="180" value="45" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(5, Math.min(180, this.value)); document.getElementById('hoverMax').value = this.value; document.getElementById('hoverMaxValue').textContent = this.value; lastHoverMaxCache = parseFloat(this.value)">
                    </div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Rotate X: <span id="rotXValue">0</span>°<span id="rotXUnit">/s</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="rotX" min="-180" max="180" step="1" value="0" style="flex: 1;"
                               oninput="document.getElementById('rotXValue').textContent = this.value; document.getElementById('rotXInput').value = this.value; onRotationChange()">
                        <input type="number" id="rotXInput" min="-180" max="180" value="0" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(-180, Math.min(180, this.value)); document.getElementById('rotX').value = this.value; document.getElementById('rotXValue').textContent = this.value; onRotationChange()">
                    </div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Rotate Y: <span id="rotYValue">30</span>°<span id="rotYUnit">/s</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="rotY" min="-180" max="180" step="1" value="30" style="flex: 1;"
                               oninput="document.getElementById('rotYValue').textContent = this.value; document.getElementById('rotYInput').value = this.value; onRotationChange()">
                        <input type="number" id="rotYInput" min="-180" max="180" value="30" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(-180, Math.min(180, this.value)); document.getElementById('rotY').value = this.value; document.getElementById('rotYValue').textContent = this.value; onRotationChange()">
                    </div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Rotate Z: <span id="rotZValue">0</span>°<span id="rotZUnit">/s</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="rotZ" min="-180" max="180" step="1" value="0" style="flex: 1;"
                               oninput="document.getElementById('rotZValue').textContent = this.value; document.getElementById('rotZInput').value = this.value; onRotationChange()">
                        <input type="number" id="rotZInput" min="-180" max="180" value="0" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(-180, Math.min(180, this.value)); document.getElementById('rotZ').value = this.value; document.getElementById('rotZValue').textContent = this.value; onRotationChange()">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3D Sphere -->
        <div class="control-section">
            <div class="section-header" onclick="toggleSection(event)">
                <h4>3D Sphere</h4>
                <div class="section-toggle">▶</div>
            </div>
            <div class="section-content">
        
        <button onclick="generateSphere()">Generate Sphere</button>
        
        <div style="margin: 8px 0;">
            <label>Sphere Points: <span id="spherePointsValue">200</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="spherePoints" min="50" max="1000" step="50" value="200" style="flex: 1;"
                       oninput="document.getElementById('spherePointsValue').textContent = this.value; document.getElementById('spherePointsInput').value = this.value">
                <input type="number" id="spherePointsInput" min="50" max="1000" step="50" value="200" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(50, Math.min(1000, this.value)); document.getElementById('spherePoints').value = this.value; document.getElementById('spherePointsValue').textContent = this.value">
            </div>
        </div>
        
        <div style="margin: 8px 0;">
            <label>Sphere Radius: <span id="sphereRadiusValue">150</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="sphereRadius" min="50" max="300" step="10" value="150" style="flex: 1;"
                       oninput="document.getElementById('sphereRadiusValue').textContent = this.value; document.getElementById('sphereRadiusInput').value = this.value">
                <input type="number" id="sphereRadiusInput" min="50" max="300" step="10" value="150" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(50, Math.min(300, this.value)); document.getElementById('sphereRadius').value = this.value; document.getElementById('sphereRadiusValue').textContent = this.value">
            </div>
        </div>
        
        <div style="margin: 8px 0;">
            <label>Depth Scale: <span id="depthScaleValue">2</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="depthScale" min="0" max="5" step="0.5" value="2" style="flex: 1;"
                       oninput="document.getElementById('depthScaleValue').textContent = this.value; document.getElementById('depthScaleInput').value = this.value">
                <input type="number" id="depthScaleInput" min="0" max="5" step="0.5" value="2" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(0, Math.min(5, this.value)); document.getElementById('depthScale').value = this.value; document.getElementById('depthScaleValue').textContent = this.value">
            </div>
                <div style="font-size: 9px; color: #666;">Size difference near/far</div>
            </div>
            </div>
        </div>
        
        <!-- 3D Effects -->
        <div class="control-section">
            <div class="section-header" onclick="toggleSection(event)">
                <h4>3D Effects</h4>
                <div class="section-toggle">▶</div>
            </div>
            <div class="section-content">
        
        <div style="margin: 8px 0;">
            <label>Extrusion: <span id="extrusionValue">0</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="extrusion" min="0" max="1000" step="5" value="0" style="flex: 1;"
                       oninput="document.getElementById('extrusionValue').textContent = this.value; document.getElementById('extrusionInput').value = this.value; applyExtrusion()">
                <input type="number" id="extrusionInput" min="0" max="1000" step="5" value="0" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(0, Math.min(1000, this.value)); document.getElementById('extrusion').value = this.value; document.getElementById('extrusionValue').textContent = this.value; applyExtrusion()">
            </div>
            <div style="font-size: 9px; color: #666;">Shape thickness/depth</div>
        </div>
        
        <div style="margin: 8px 0;">
            <label>Extrusion Layers: <span id="extrusionLayersValue">5</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="extrusionLayers" min="1" max="20" step="1" value="5" style="flex: 1;"
                       oninput="document.getElementById('extrusionLayersValue').textContent = this.value; document.getElementById('extrusionLayersInput').value = this.value; applyExtrusion()">
                <input type="number" id="extrusionLayersInput" min="1" max="20" step="1" value="5" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(1, Math.min(20, this.value)); document.getElementById('extrusionLayers').value = this.value; document.getElementById('extrusionLayersValue').textContent = this.value; applyExtrusion()">
            </div>
        </div>
        
        <div style="margin: 8px 0;">
            <label>Projections: <span id="projectionsValue">1</span></label>
            <div style="display: flex; gap: 8px;">
                <input type="range" id="projections" min="1" max="12" step="1" value="1" style="flex: 1;"
                       oninput="document.getElementById('projectionsValue').textContent = this.value; document.getElementById('projectionsInput').value = this.value; applyProjections()">
                <input type="number" id="projectionsInput" min="1" max="12" step="1" value="1" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                       oninput="this.value = Math.max(1, Math.min(12, this.value)); document.getElementById('projections').value = this.value; document.getElementById('projectionsValue').textContent = this.value; applyProjections()">>
            <div style="font-size: 9px; color: #666;">Multiple rotated instances</div>
        </div>
        
        <div style="margin: 8px 0;">
            <label>Projection Axis:</label>
            <select id="projectionAxis" style="width: 100%; padding: 4px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;" onchange="applyProjections()">
                <option value="y">Y-axis (spin)</option>
                <option value="z">Z-axis (flat)</option>
                <option value="x">X-axis (vertical)</option>
            </select>
        </div>
        
        <div style="margin: 8px 0;">
            <label>
                <input type="checkbox" id="wireframe" onchange="updateWireframe()">
                Wireframe Mode
            </label>
        </div>
        
        <div style="margin: 8px 0;">
            <label>
                <input type="checkbox" id="depthFog" checked>
                Depth Fog
            </label>
        </div>
        
        <div style="margin: 8px 0;">
            <label>
                <input type="checkbox" id="perspective">
                Perspective Projection
            </label>
        </div>
            </div>
        </div>
        
        <!-- Multi-Frame Morph -->
        <div class="control-section">
            <div class="section-header" onclick="toggleSection(event)">
                <h4>Multi-Frame Morph</h4>
                <div class="section-toggle collapsed">▶</div>
            </div>
            <div class="section-content collapsed">
                <div style="font-size: 9px; color: #666; margin-bottom: 8px;">
                    Add multiple images/SVGs and right-click to morph between them
                </div>
                
                <button onclick="addCurrentAsFrame()">+ Add Current as Frame</button>
                
                <div style="margin: 8px 0;">
                    <label>Morph Speed: <span id="morphSpeedValue">0.02</span></label>
                    <div style="display: flex; gap: 8px;">
                        <input type="range" id="morphSpeedSlider" min="0.005" max="0.1" step="0.005" value="0.02" style="flex: 1;"
                               oninput="morphSpeed = parseFloat(this.value); document.getElementById('morphSpeedValue').textContent = this.value; document.getElementById('morphSpeedInput').value = this.value">
                        <input type="number" id="morphSpeedInput" min="0.005" max="0.1" step="0.005" value="0.02" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                               oninput="this.value = Math.max(0.005, Math.min(0.1, this.value)); morphSpeed = parseFloat(this.value); document.getElementById('morphSpeedSlider').value = this.value; document.getElementById('morphSpeedValue').textContent = this.value">
                    </div>
                </div>
                
                <div style="margin: 8px 0;">
                    <label>Frames: <span id="frameCount">0</span></label>
                    <div id="frameList" style="max-height: 120px; overflow-y: auto; background: #111; border: 1px solid #333; border-radius: 4px; margin-top: 4px;">
                        <div style="padding: 8px; color: #666; font-size: 10px;">No frames added yet</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 4px; margin-top: 8px;">
                    <button onclick="morphToPrevFrame()" style="flex: 1;">&lt; Prev</button>
                    <button onclick="morphToNextFrame()" style="flex: 1;">Next &gt;</button>
                </div>
                
                <button onclick="clearAllFrames()" style="margin-top: 8px; background: #4a2020;">Clear All Frames</button>
                
                <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #333;">
                    <div style="font-size: 10px; color: #4ade80; margin-bottom: 6px;">Export Frames</div>
                    <button onclick="exportCurrentFrame()">Export Current Frame</button>
                    <button onclick="exportAllFrames()">Export All Frames</button>
                    <button onclick="importFrames()">Import Frames</button>
                    <input type="file" id="importFrameFile" accept=".json" style="display: none;" onchange="handleFrameImport(event)">
                </div>
                
                <div style="font-size: 9px; color: #888; margin-top: 8px;">
                    Tip: Right-click canvas to morph to next frame
                </div>
            </div>
        </div>
        
        <div class="svg-input">
            <label>SVG / Image Input:</label>
            <textarea id="svgInput" placeholder="Paste your SVG code here..." oninput="loadSVG()"></textarea>
            
            <div style="margin: 10px 0;">
                <label>Or upload PNG/Image:</label>
                <input type="file" id="imageFile" accept="image/png,image/jpeg,image/webp,image/gif" 
                       onclick="this.value=null;" onchange="loadImageFile()" style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;">
            </div>
            
            <div style="margin: 10px 0;">
                <label>Sampling Mode:</label>
                <select id="samplingMode" style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;" onchange="reloadImage()">
                    <option value="fill">Fill (all pixels)</option>
                    <option value="border" selected>Border/Edges Only</option>
                </select>
            </div>
            
            <div style="margin: 10px 0;">
                <label>Border Density (step): <span id="borderDensityValue">2</span></label>
                <div style="display: flex; gap: 8px;">
                    <input type="range" id="borderDensity" min="1" max="1000" step="1" value="2" style="flex: 1;"
                           oninput="document.getElementById('borderDensityValue').textContent = this.value; document.getElementById('borderDensityInput').value = this.value; reloadImage()">
                    <input type="number" id="borderDensityInput" min="1" max="1000" step="1" value="2" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                           oninput="this.value = Math.max(1, Math.min(1000, this.value)); document.getElementById('borderDensity').value = this.value; document.getElementById('borderDensityValue').textContent = this.value; reloadImage()">
                </div>
                <div style="font-size: 10px; color: #666;">Lower = more points</div>
            </div>
            
            <div style="margin: 10px 0;">
                <label>Image Scale: <span id="imageScaleValue">1</span>x</label>
                <div style="display: flex; gap: 8px;">
                    <input type="range" id="imageScale" min="0.2" max="5" step="0.1" value="1" style="flex: 1;"
                           oninput="document.getElementById('imageScaleValue').textContent = this.value; document.getElementById('imageScaleInput').value = this.value; reloadImage()">
                    <input type="number" id="imageScaleInput" min="0.2" max="5" step="0.1" value="1" style="width: 60px; padding: 4px; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 4px;"
                           oninput="this.value = Math.max(0.2, Math.min(5, this.value)); document.getElementById('imageScale').value = this.value; document.getElementById('imageScaleValue').textContent = this.value; reloadImage()">
                </div>
                <div style="font-size: 10px; color: #666;">Resize projected image</div>
            </div>
            
            <div style="margin: 10px 0;">
                <label>
                    <input type="checkbox" id="useColorPalette" onchange="reloadImage()">
                    Use Color Palette
                </label>
                <div style="font-size: 9px; color: #666;">Match colors from image</div>
            </div>
            
            <div style="margin: 10px 0;">
                <label>Palette:</label>
                <select id="colorPalette" style="width: 100%; padding: 5px; background: #222; color: #fff; border: 1px solid #444; border-radius: 4px;" onchange="reloadImage()">
                    <option value="cga" selected>CGA (16 colors)</option>
                </select>
            </div>
            
            <div id="svgStatus" style="font-size: 11px; margin-top: 5px; color: #888;">
                Paste SVG or upload image to auto-load
            </div>
        </div>
        
        <div class="info">
            <div>Count: <span id="count">0</span></div>
            <div>FPS: <span id="fps">0</span></div>
            <div style="margin-top: 8px; font-size: 9px; color: #888;">
                <label>
                    <input type="checkbox" id="perfDebug" onchange="togglePerfDebug()">
                    Performance Debug
                </label>
            </div>
        </div>
    </div>
    
    <div class="perf-debug" id="perfDebug" style="display: none;">
        <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #333; font-weight: bold;">PERFORMANCE DEBUG</div>
        
        <div class="perf-row">
            <span class="perf-label">Avg FPS</span>
            <span class="perf-value" id="perfAvgFps">60</span>
        </div>
        
        <div class="perf-row">
            <span class="perf-label">Frame Time</span>
            <span class="perf-value" id="perfFrameTime">16.7ms</span>
        </div>
        
        <div class="perf-row">
            <span class="perf-label">Max Frame</span>
            <span class="perf-value" id="perfMaxFrame">16.7ms</span>
        </div>
        
        <div class="perf-row">
            <span class="perf-label">Jank Frames</span>
            <span class="perf-value" id="perfJankCount">0</span>
        </div>
        
        <div class="perf-chart" id="perfChart"></div>
        
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #333; font-size: 9px;">
            <div class="perf-row">
                <span class="perf-label">Memory</span>
                <span class="perf-value" id="perfMemory">-</span>
            </div>
            <div class="perf-row">
                <span class="perf-label">Long Tasks</span>
                <span class="perf-value" id="perfLongTasks">0</span>
            </div>
            <div style="margin-top: 8px; font-size: 8px; color: #666; line-height: 1.3;">
                <div>▌ Green = smooth</div>
                <div>▌ Red = jank (>33ms)</div>
                <div style="margin-top: 4px;">Jank = frame drop</div>
            </div>
        </div>
    </div>
    
    <script src="main.js"></script>
</body>
</html>
